<?xml version="1.0"?>
<project xmlns:ivy="antlib:org.apache.ivy.ant" name="common">
    
    <!-- -->
    <property file="${config.dir}/common.properties"/>
    
    <!-- -->
    <path id="lib.path.id">
        <fileset dir="${lib.dir}"/>
    </path>
    
    <!-- -->
    <path id="run.path.id">
        <path refid="lib.path.id"/>
        <path location="${classes.dir}"/>
    </path>
    
    <!-- -->
    <target name="load-ivy">
        <taskdef resource="org/apache/ivy/ant/antlib.xml" 
            uri="antlib:org.apache.ivy.ant" classpath="${ivy.jar.file}"/>
    </target>
    
    <!-- -->
    <target name="configure" depends="load-ivy">
        <echo message="${ivy.settings.file}"/>
       	<ivy:settings/>
    </target>
    
    <!-- -->
    <target name="resolve" depends="clean-lib, load-ivy">
        <mkdir dir="${lib.dir}"/>
        <ivy:resolve file="${ivy.file}"/>
        <ivy:retrieve pattern="${lib.dir}/[conf]/[artifact]-[revision].[ext]"/>
    </target>
    
    <!-- -->
    <target name="report" depends="resolve">
        <ivy:report todir="${build.dir}"/>
    </target>
    
    <!-- -->
    <target name="compile" depends="resolve">
        <echo message="Compiling ${src.dir}"/>
        <mkdir dir="${classes.dir}" />
        <javac 
            srcdir="${src.dir}" 
			destdir="${classes.dir}" 
			debug="${compile.debug}"
			optimize="${compile.optimize}" 
			source="${compile.source}"
			target="${compile.target}"
			deprecation="${compile.deprecation}"
			encoding="${compile.encoding}"
			classpathref="lib.path.id"/>
    </target>
    
    <!-- -->
    <target name="jar" depends="version, compile">
        <jar destfile="${jar.file}">
            <fileset dir="${classes.dir}" />
            <manifest>
                <attribute name="Built-By" value="${user.name}"/>
                <attribute name="Build-Version" value="${version}" />
            </manifest>
        </jar>
    </target>
    
    <!-- -->
    <target name="version">
		<tstamp>
			<format property="now" pattern="yyyyMMddHHmmss"/>
		</tstamp>
        <!--<property name="ivy.new.revision" value="${module.version.target}-${now}"/>-->
        <property name="version" value="${now}"/>
    </target>
    
    <!-- -->
    <target name="publish" depends="version, jar">
    	<ivy:publish artifactspattern="${build.dir}/[artifact].[ext]" 
    			        resolver="local"
    			        pubrevision="${version}"
				        pubdate="${now}"
    			        status="integration"
    					forcedeliver="true"
    					overwrite="true"
    	/>
        <echo message="project ${ant.project.name} published locally with version ${version}" />
    </target>
    
    <!-- -->
    <target name="clean-ivy">
        <delete dir="${ivy.home}"/>
	</target>
	
	<!-- -->
    <target name="clean-lib">
        <delete includeemptydirs="true" dir="${lib.dir}"/>
    </target>

    <!-- -->
    <target name="clean-build">
        <delete includeemptydirs="true" dir="${build.dir}"/>
    </target>

    <!-- -->
    <target name="clean" depends="clean-build"/>
</project>
